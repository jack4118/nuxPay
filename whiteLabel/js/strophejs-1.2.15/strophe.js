!function(t,e){if("function"==typeof define&&define.amd)define([],e);else{var n=e();t.Strophe=n.Strophe,t.$build=n.$build,t.$iq=n.$iq,t.$msg=n.$msg,t.$pres=n.$pres,t.SHA1=n.SHA1,t.MD5=n.MD5,t.b64_hmac_sha1=n.b64_hmac_sha1,t.b64_sha1=n.b64_sha1,t.str_hmac_sha1=n.str_hmac_sha1,t.str_sha1=n.str_sha1}}(this,function(){var t,s,i,p,r,o,_,f,m,g,S,b,n,a,y,e,h,c,u,l,d;function v(t,e){return n.call(t,e)}function x(t,e){var n,s,i,r,o,a,h,c,u,l,d,p=e&&e.split("/"),_=S.map,f=_&&_["*"]||{};if(t){for(o=(t=t.split("/")).length-1,S.nodeIdCompat&&y.test(t[o])&&(t[o]=t[o].replace(y,"")),"."===t[0].charAt(0)&&p&&(t=p.slice(0,p.length-1).concat(t)),u=0;u<t.length;u++)if("."===(d=t[u]))t.splice(u,1),u-=1;else if(".."===d){if(0===u||1===u&&".."===t[2]||".."===t[u-1])continue;0<u&&(t.splice(u-1,2),u-=2)}t=t.join("/")}if((p||f)&&_){for(u=(n=t.split("/")).length;0<u;u-=1){if(s=n.slice(0,u).join("/"),p)for(l=p.length;0<l;l-=1)if(i=(i=_[p.slice(0,l).join("/")])&&i[s]){r=i,a=u;break}if(r)break;!h&&f&&f[s]&&(h=f[s],c=u)}!r&&h&&(r=h,a=c),r&&(n.splice(0,a,r),t=n.join("/"))}return t}function T(e,n){return function(){var t=a.call(arguments,0);return"string"!=typeof t[0]&&1===t.length&&t.push(null),o.apply(p,t.concat([e,n]))}}function A(e){return function(t){m[e]=t}}function N(t){if(v(g,t)){var e=g[t];delete g[t],b[t]=!0,r.apply(p,e)}if(!v(m,t)&&!v(b,t))throw new Error("No "+t);return m[t]}function w(t){var e,n=t?t.indexOf("!"):-1;return-1<n&&(e=t.substring(0,n),t=t.substring(n+1,t.length)),[e,t]}function C(t){return t?w(t):[]}return m={},g={},S={},b={},n=Object.prototype.hasOwnProperty,a=[].slice,y=/\.js$/,_=function(t,e){var n,s=w(t),i=s[0],r=e[1];return t=s[1],i&&(n=N(i=x(i,r))),i?t=n&&n.normalize?n.normalize(t,function(e){return function(t){return x(t,e)}}(r)):x(t,r):(i=(s=w(t=x(t,r)))[0],t=s[1],i&&(n=N(i))),{f:i?i+"!"+t:t,n:t,pr:i,p:n}},f={require:function(t){return T(t)},exports:function(t){var e=m[t];return void 0!==e?e:m[t]={}},module:function(t){return{id:t,uri:"",exports:m[t],config:function(t){return function(){return S&&S.config&&S.config[t]||{}}}(t)}}},r=function(t,e,n,s){var i,r,o,a,h,c,u,l=[],d=typeof n;if(c=C(s=s||t),"undefined"==d||"function"==d){for(e=!e.length&&n.length?["require","exports","module"]:e,h=0;h<e.length;h+=1)if("require"===(r=(a=_(e[h],c)).f))l[h]=f.require(t);else if("exports"===r)l[h]=f.exports(t),u=!0;else if("module"===r)i=l[h]=f.module(t);else if(v(m,r)||v(g,r)||v(b,r))l[h]=N(r);else{if(!a.p)throw new Error(t+" missing "+r);a.p.load(a.n,T(s,!0),A(r),{}),l[h]=m[r]}o=n?n.apply(m[t],l):void 0,t&&(i&&i.exports!==p&&i.exports!==m[t]?m[t]=i.exports:o===p&&u||(m[t]=o))}else t&&(m[t]=n)},t=s=o=function(t,e,n,s,i){if("string"==typeof t)return f[t]?f[t](e):N(_(t,C(e)).f);if(!t.splice){if((S=t).deps&&o(S.deps,S.callback),!e)return;e.splice?(t=e,e=n,n=null):t=p}return e=e||function(){},"function"==typeof n&&(n=s,s=i),s?r(p,t,e,n):setTimeout(function(){r(p,t,e,n)},4),o},o.config=function(t){return o(t)},t._defined=m,(i=function(t,e,n){if("string"!=typeof t)throw new Error("See almond README: incorrect module build, no module name");e.splice||(n=e,e=[]),v(m,t)||v(g,t)||(g[t]=[t,e,n])}).amd={jQuery:!0},i("node_modules/almond/almond.js",function(){}),function(t,e){if("function"!=typeof i||!i.amd)return e(t);i("strophe-polyfill",[],function(){return e(t)})}(this,function(t){Function.prototype.bind||(Function.prototype.bind=function(t){var e=this,n=Array.prototype.slice,s=Array.prototype.concat,i=n.call(arguments,1);return function(){return e.apply(t||this,s.call(i,n.call(arguments,0)))}}),Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),Array.prototype.indexOf||(Array.prototype.indexOf=function(t){var e=this.length,n=Number(arguments[1])||0;for((n=n<0?Math.ceil(n):Math.floor(n))<0&&(n+=e);n<e;n++)if(n in this&&this[n]===t)return n;return-1}),Array.prototype.forEach||(Array.prototype.forEach=function(t,e){var n,s;if(null===this)throw new TypeError(" this is null or not defined");var i=Object(this),r=i.length>>>0;if("function"!=typeof t)throw new TypeError(t+" is not a function");for(1<arguments.length&&(n=e),s=0;s<r;){var o;s in i&&(o=i[s],t.call(n,o,s,i)),s++}});var u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";t.btoa||(t.btoa=function(t){for(var e,n,s,i,r,o,a,h="",c=0;i=(e=t.charCodeAt(c++))>>2,r=(3&e)<<4|(n=t.charCodeAt(c++))>>4,o=(15&n)<<2|(s=t.charCodeAt(c++))>>6,a=63&s,isNaN(n)?(r=(3&e)<<4,o=a=64):isNaN(s)&&(a=64),h=h+u.charAt(i)+u.charAt(r)+u.charAt(o)+u.charAt(a),c<t.length;);return h}),t.atob||(t.atob=function(t){var e,n,s,i,r,o,a="",h=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");e=u.indexOf(t.charAt(h++))<<2|(i=u.indexOf(t.charAt(h++)))>>4,n=(15&i)<<4|(r=u.indexOf(t.charAt(h++)))>>2,s=(3&r)<<6|(o=u.indexOf(t.charAt(h++))),a+=String.fromCharCode(e),64!==r&&(a+=String.fromCharCode(n)),64!==o&&(a+=String.fromCharCode(s)),h<t.length;);return a})}),e=this,h=function(){function a(t,e){t[e>>5]|=128<<24-e%32,t[15+(e+64>>9<<4)]=e;var n,s,i,r,o,a,h,c,u,l=new Array(80),d=1732584193,p=-271733879,_=-1732584194,f=271733878,m=-1009589776;for(n=0;n<t.length;n+=16){for(r=d,o=p,a=_,h=f,c=m,s=0;s<80;s++)l[s]=s<16?t[n+s]:b(l[s-3]^l[s-8]^l[s-14]^l[s-16],1),i=S(S(b(d,5),g(s,p,_,f)),S(S(m,l[s]),(u=s)<20?1518500249:u<40?1859775393:u<60?-1894007588:-899497514)),m=f,f=_,_=b(p,30),p=d,d=i;d=S(d,r),p=S(p,o),_=S(_,a),f=S(f,h),m=S(m,c)}return[d,p,_,f,m]}function g(t,e,n,s){return t<20?e&n|~e&s:t<40?e^n^s:t<60?e&n|e&s|n&s:e^n^s}function n(t,e){var n=h(t);16<n.length&&(n=a(n,8*t.length));for(var s=new Array(16),i=new Array(16),r=0;r<16;r++)s[r]=909522486^n[r],i[r]=1549556828^n[r];var o=a(s.concat(h(e)),512+8*e.length);return a(i.concat(o),672)}function S(t,e){var n=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(n>>16)<<16|65535&n}function b(t,e){return t<<e|t>>>32-e}function h(t){for(var e=[],n=0;n<8*t.length;n+=8)e[n>>5]|=(255&t.charCodeAt(n/8))<<24-n%32;return e}function s(t){for(var e="",n=0;n<32*t.length;n+=8)e+=String.fromCharCode(t[n>>5]>>>24-n%32&255);return e}function i(t){for(var e,n,s="",i=0;i<4*t.length;i+=3)for(e=(t[i>>2]>>8*(3-i%4)&255)<<16|(t[i+1>>2]>>8*(3-(i+1)%4)&255)<<8|t[i+2>>2]>>8*(3-(i+2)%4)&255,n=0;n<4;n++)8*i+6*n>32*t.length?s+="=":s+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>6*(3-n)&63);return s}return{b64_hmac_sha1:function(t,e){return i(n(t,e))},b64_sha1:function(t){return i(a(h(t),8*t.length))},binb2str:s,core_hmac_sha1:n,str_hmac_sha1:function(t,e){return s(n(t,e))},str_sha1:function(t){return s(a(h(t),8*t.length))}}},"function"==typeof i&&i.amd?i("strophe-sha1",[],function(){return h()}):"object"==typeof exports?module.exports=h():e.SHA1=h(),c=this,u=function(){function l(t,e){var n=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(n>>16)<<16|65535&n}function e(t){for(var e=[],n=0;n<8*t.length;n+=8)e[n>>5]|=(255&t.charCodeAt(n/8))<<n%32;return e}function a(t,e,n,s,i,r){return l(function(t,e){return t<<e|t>>>32-e}(l(l(e,t),l(s,r)),i),n)}function d(t,e,n,s,i,r,o){return a(e&n|~e&s,t,e,i,r,o)}function p(t,e,n,s,i,r,o){return a(e&s|n&~s,t,e,i,r,o)}function _(t,e,n,s,i,r,o){return a(e^n^s,t,e,i,r,o)}function f(t,e,n,s,i,r,o){return a(n^(e|~s),t,e,i,r,o)}function n(t,e){t[e>>5]|=128<<e%32,t[14+(e+64>>>9<<4)]=e;for(var n,s,i,r,o=1732584193,a=-271733879,h=-1732584194,c=271733878,u=0;u<t.length;u+=16)o=d(n=o,s=a,i=h,r=c,t[u+0],7,-680876936),c=d(c,o,a,h,t[u+1],12,-389564586),h=d(h,c,o,a,t[u+2],17,606105819),a=d(a,h,c,o,t[u+3],22,-1044525330),o=d(o,a,h,c,t[u+4],7,-176418897),c=d(c,o,a,h,t[u+5],12,1200080426),h=d(h,c,o,a,t[u+6],17,-1473231341),a=d(a,h,c,o,t[u+7],22,-45705983),o=d(o,a,h,c,t[u+8],7,1770035416),c=d(c,o,a,h,t[u+9],12,-1958414417),h=d(h,c,o,a,t[u+10],17,-42063),a=d(a,h,c,o,t[u+11],22,-1990404162),o=d(o,a,h,c,t[u+12],7,1804603682),c=d(c,o,a,h,t[u+13],12,-40341101),h=d(h,c,o,a,t[u+14],17,-1502002290),a=d(a,h,c,o,t[u+15],22,1236535329),o=p(o,a,h,c,t[u+1],5,-165796510),c=p(c,o,a,h,t[u+6],9,-1069501632),h=p(h,c,o,a,t[u+11],14,643717713),a=p(a,h,c,o,t[u+0],20,-373897302),o=p(o,a,h,c,t[u+5],5,-701558691),c=p(c,o,a,h,t[u+10],9,38016083),h=p(h,c,o,a,t[u+15],14,-660478335),a=p(a,h,c,o,t[u+4],20,-405537848),o=p(o,a,h,c,t[u+9],5,568446438),c=p(c,o,a,h,t[u+14],9,-1019803690),h=p(h,c,o,a,t[u+3],14,-187363961),a=p(a,h,c,o,t[u+8],20,1163531501),o=p(o,a,h,c,t[u+13],5,-1444681467),c=p(c,o,a,h,t[u+2],9,-51403784),h=p(h,c,o,a,t[u+7],14,1735328473),a=p(a,h,c,o,t[u+12],20,-1926607734),o=_(o,a,h,c,t[u+5],4,-378558),c=_(c,o,a,h,t[u+8],11,-2022574463),h=_(h,c,o,a,t[u+11],16,1839030562),a=_(a,h,c,o,t[u+14],23,-35309556),o=_(o,a,h,c,t[u+1],4,-1530992060),c=_(c,o,a,h,t[u+4],11,1272893353),h=_(h,c,o,a,t[u+7],16,-155497632),a=_(a,h,c,o,t[u+10],23,-1094730640),o=_(o,a,h,c,t[u+13],4,681279174),c=_(c,o,a,h,t[u+0],11,-358537222),h=_(h,c,o,a,t[u+3],16,-722521979),a=_(a,h,c,o,t[u+6],23,76029189),o=_(o,a,h,c,t[u+9],4,-640364487),c=_(c,o,a,h,t[u+12],11,-421815835),h=_(h,c,o,a,t[u+15],16,530742520),a=_(a,h,c,o,t[u+2],23,-995338651),o=f(o,a,h,c,t[u+0],6,-198630844),c=f(c,o,a,h,t[u+7],10,1126891415),h=f(h,c,o,a,t[u+14],15,-1416354905),a=f(a,h,c,o,t[u+5],21,-57434055),o=f(o,a,h,c,t[u+12],6,1700485571),c=f(c,o,a,h,t[u+3],10,-1894986606),h=f(h,c,o,a,t[u+10],15,-1051523),a=f(a,h,c,o,t[u+1],21,-2054922799),o=f(o,a,h,c,t[u+8],6,1873313359),c=f(c,o,a,h,t[u+15],10,-30611744),h=f(h,c,o,a,t[u+6],15,-1560198380),a=f(a,h,c,o,t[u+13],21,1309151649),o=f(o,a,h,c,t[u+4],6,-145523070),c=f(c,o,a,h,t[u+11],10,-1120210379),h=f(h,c,o,a,t[u+2],15,718787259),a=f(a,h,c,o,t[u+9],21,-343485551),o=l(o,n),a=l(a,s),h=l(h,i),c=l(c,r);return[o,a,h,c]}return{hexdigest:function(t){return function(t){for(var e="0123456789abcdef",n="",s=0;s<4*t.length;s++)n+=e.charAt(t[s>>2]>>s%4*8+4&15)+e.charAt(t[s>>2]>>s%4*8&15);return n}(n(e(t),8*t.length))},hash:function(t){return function(t){for(var e="",n=0;n<32*t.length;n+=8)e+=String.fromCharCode(t[n>>5]>>>n%32&255);return e}(n(e(t),8*t.length))}}},"function"==typeof i&&i.amd?i("strophe-md5",[],function(){return u()}):"object"==typeof exports?module.exports=u():c.MD5=u(),l=this,d=function(){return{utf16to8:function(t){var e,n,s="",i=t.length;for(e=0;e<i;e++)0<=(n=t.charCodeAt(e))&&n<=127?s+=t.charAt(e):(2047<n?(s+=String.fromCharCode(224|n>>12&15),s+=String.fromCharCode(128|n>>6&63)):s+=String.fromCharCode(192|n>>6&31),s+=String.fromCharCode(128|n>>0&63));return s},addCookies:function(t){var e,n,s,i,r,o,a;for(e in t||{})a=o=r="",s="object"==typeof(n=t[e]),i=escape(unescape(s?n.value:n)),s&&(r=n.expires?";expires="+n.expires:"",o=n.domain?";domain="+n.domain:"",a=n.path?";path="+n.path:""),document.cookie=e+"="+i+r+o+a}}},"function"==typeof i&&i.amd?i("strophe-utils",[],function(){return d()}):"object"==typeof exports?module.exports=d():l.stropheUtils=d(),function(t,e){if("function"==typeof i&&i.amd)i("strophe-core",["strophe-sha1","strophe-md5","strophe-utils"],function(){return e.apply(this,arguments)});else if("object"==typeof exports)module.exports=e(s("./sha1"),s("./md5"),s("./utils"));else{var n=e(t.SHA1,t.MD5,t.stropheUtils);t.Strophe=n.Strophe,t.$build=n.$build,t.$iq=n.$iq,t.$msg=n.$msg,t.$pres=n.$pres,t.SHA1=n.SHA1,t.MD5=n.MD5,t.b64_hmac_sha1=n.SHA1.b64_hmac_sha1,t.b64_sha1=n.SHA1.b64_sha1,t.str_hmac_sha1=n.SHA1.str_hmac_sha1,t.str_sha1=n.SHA1.str_sha1}}(this,function(b,_,y){var d;function r(t,e){return new d.Builder(t,e)}function i(t){return new d.Builder("iq",t)}function n(t){return new d.Builder("presence",t)}return(d={VERSION:"1.2.15",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(t){for(var e=0;e<d.XHTML.tags.length;e++)if(t===d.XHTML.tags[e])return!0;return!1},validAttribute:function(t,e){if(void 0!==d.XHTML.attributes[t]&&0<d.XHTML.attributes[t].length)for(var n=0;n<d.XHTML.attributes[t].length;n++)if(e===d.XHTML.attributes[t][n])return!0;return!1},validCSS:function(t){for(var e=0;e<d.XHTML.css.length;e++)if(t===d.XHTML.css[e])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10},ErrorCondition:{BAD_FORMAT:"bad-format",CONFLICT:"conflict",MISSING_JID_NODE:"x-strophe-bad-non-anon-jid",NO_AUTH_MECH:"no-auth-mech",UNKNOWN_REASON:"unknown"},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace:function(t,e){d.NS[t]=e},forEachChild:function(t,e,n){var s,i;for(s=0;s<t.childNodes.length;s++)(i=t.childNodes[s]).nodeType!==d.ElementType.NORMAL||e&&!this.isTagEqual(i,e)||n(i)},isTagEqual:function(t,e){return t.tagName===e},_xmlGenerator:null,_makeGenerator:function(){var t;return void 0===document.implementation.createDocument||document.implementation.createDocument&&document.documentMode&&document.documentMode<10?(t=this._getIEXmlDom()).appendChild(t.createElement("strophe")):t=document.implementation.createDocument("jabber:client","strophe",null),t},xmlGenerator:function(){return d._xmlGenerator||(d._xmlGenerator=d._makeGenerator()),d._xmlGenerator},_getIEXmlDom:function(){for(var e=null,t=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],n=0;n<t.length&&null===e;n++)try{e=new ActiveXObject(t[n])}catch(t){e=null}return e},xmlElement:function(t){if(!t)return null;var e,n,s,i=d.xmlGenerator().createElement(t);for(e=1;e<arguments.length;e++){var r=arguments[e];if(r)if("string"==typeof r||"number"==typeof r)i.appendChild(d.xmlTextNode(r));else if("object"==typeof r&&"function"==typeof r.sort)for(n=0;n<r.length;n++){var o=r[n];"object"==typeof o&&"function"==typeof o.sort&&void 0!==o[1]&&null!==o[1]&&i.setAttribute(o[0],o[1])}else if("object"==typeof r)for(s in r)r.hasOwnProperty(s)&&void 0!==r[s]&&null!==r[s]&&i.setAttribute(s,r[s])}return i},xmlescape:function(t){return t=(t=(t=(t=(t=t.replace(/\&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/'/g,"&apos;")).replace(/"/g,"&quot;")},xmlunescape:function(t){return t=(t=(t=(t=(t=t.replace(/\&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&apos;/g,"'")).replace(/&quot;/g,'"')},xmlTextNode:function(t){return d.xmlGenerator().createTextNode(t)},xmlHtmlNode:function(t){var e;DOMParser?e=(new DOMParser).parseFromString(t,"text/xml"):((e=new ActiveXObject("Microsoft.XMLDOM")).async="false",e.loadXML(t));return e},getText:function(t){if(!t)return null;var e="";0===t.childNodes.length&&t.nodeType===d.ElementType.TEXT&&(e+=t.nodeValue);for(var n=0;n<t.childNodes.length;n++)t.childNodes[n].nodeType===d.ElementType.TEXT&&(e+=t.childNodes[n].nodeValue);return d.xmlescape(e)},copyElement:function(t){var e,n;if(t.nodeType===d.ElementType.NORMAL){for(n=d.xmlElement(t.tagName),e=0;e<t.attributes.length;e++)n.setAttribute(t.attributes[e].nodeName,t.attributes[e].value);for(e=0;e<t.childNodes.length;e++)n.appendChild(d.copyElement(t.childNodes[e]))}else t.nodeType===d.ElementType.TEXT&&(n=d.xmlGenerator().createTextNode(t.nodeValue));return n},createHtml:function(t){var e,n,s,i,r,o,a,h,c,u,l;if(t.nodeType===d.ElementType.NORMAL)if(i=t.nodeName.toLowerCase(),d.XHTML.validTag(i))try{for(n=d.xmlElement(i),e=0;e<d.XHTML.attributes[i].length;e++)if(r=d.XHTML.attributes[i][e],null!=(o=t.getAttribute(r))&&""!==o&&!1!==o&&0!==o)if("style"===r&&"object"==typeof o&&void 0!==o.cssText&&(o=o.cssText),"style"===r){for(a=[],h=o.split(";"),s=0;s<h.length;s++)u=(c=h[s].split(":"))[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),d.XHTML.validCSS(u)&&(l=c[1].replace(/^\s*/,"").replace(/\s*$/,""),a.push(u+": "+l));0<a.length&&(o=a.join("; "),n.setAttribute(r,o))}else n.setAttribute(r,o);for(e=0;e<t.childNodes.length;e++)n.appendChild(d.createHtml(t.childNodes[e]))}catch(t){n=d.xmlTextNode("")}else for(n=d.xmlGenerator().createDocumentFragment(),e=0;e<t.childNodes.length;e++)n.appendChild(d.createHtml(t.childNodes[e]));else if(t.nodeType===d.ElementType.FRAGMENT)for(n=d.xmlGenerator().createDocumentFragment(),e=0;e<t.childNodes.length;e++)n.appendChild(d.createHtml(t.childNodes[e]));else t.nodeType===d.ElementType.TEXT&&(n=d.xmlTextNode(t.nodeValue));return n},escapeNode:function(t){return"string"!=typeof t?t:t.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(t){return"string"!=typeof t?t:t.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(t){return t.indexOf("@")<0?null:t.split("@")[0]},getDomainFromJid:function(t){var e=d.getBareJidFromJid(t);if(e.indexOf("@")<0)return e;var n=e.split("@");return n.splice(0,1),n.join("@")},getResourceFromJid:function(t){var e=t.split("/");return e.length<2?null:(e.splice(0,1),e.join("/"))},getBareJidFromJid:function(t){return t?t.split("/")[0]:null},_handleError:function(t){void 0!==t.stack&&d.fatal(t.stack),t.sourceURL?d.fatal("error: "+this.handler+" "+t.sourceURL+":"+t.line+" - "+t.name+": "+t.message):t.fileName?d.fatal("error: "+this.handler+" "+t.fileName+":"+t.lineNumber+" - "+t.name+": "+t.message):d.fatal("error: "+t.message)},log:function(t,e){t===this.LogLevel.FATAL&&"object"==typeof window.console&&"function"==typeof window.console.error&&window.console.error(e)},debug:function(t){this.log(this.LogLevel.DEBUG,t)},info:function(t){this.log(this.LogLevel.INFO,t)},warn:function(t){this.log(this.LogLevel.WARN,t)},error:function(t){this.log(this.LogLevel.ERROR,t)},fatal:function(t){this.log(this.LogLevel.FATAL,t)},serialize:function(t){var e;if(!t)return null;"function"==typeof t.tree&&(t=t.tree());var n,s,i=t.nodeName;for(t.getAttribute("_realname")&&(i=t.getAttribute("_realname")),e="<"+i,n=0;n<t.attributes.length;n++)"_realname"!==t.attributes[n].nodeName&&(e+=" "+t.attributes[n].nodeName+"='"+d.xmlescape(t.attributes[n].value)+"'");if(0<t.childNodes.length){for(e+=">",n=0;n<t.childNodes.length;n++)switch((s=t.childNodes[n]).nodeType){case d.ElementType.NORMAL:e+=d.serialize(s);break;case d.ElementType.TEXT:e+=d.xmlescape(s.nodeValue);break;case d.ElementType.CDATA:e+="<![CDATA["+s.nodeValue+"]]>"}e+="</"+i+">"}else e+="/>";return e},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(t,e){d._connectionPlugins[t]=e},Builder:function(t,e){"presence"!==t&&"message"!==t&&"iq"!==t||(e&&!e.xmlns?e.xmlns=d.NS.CLIENT:e=e||{xmlns:d.NS.CLIENT}),this.nodeTree=d.xmlElement(t,e),this.node=this.nodeTree}}).Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return d.serialize(this.nodeTree)},up:function(){return this.node=this.node.parentNode,this},root:function(){return this.node=this.nodeTree,this},attrs:function(t){for(var e in t)t.hasOwnProperty(e)&&(void 0===t[e]?this.node.removeAttribute(e):this.node.setAttribute(e,t[e]));return this},c:function(t,e,n){var s=d.xmlElement(t,e,n);return this.node.appendChild(s),"string"!=typeof n&&"number"!=typeof n&&(this.node=s),this},cnode:function(t){var e,n=d.xmlGenerator();try{e=void 0!==n.importNode}catch(t){e=!1}var s=e?n.importNode(t,!0):d.copyElement(t);return this.node.appendChild(s),this.node=s,this},t:function(t){var e=d.xmlTextNode(t);return this.node.appendChild(e),this},h:function(t){var e=document.createElement("body");e.innerHTML=t;for(var n=d.createHtml(e);0<n.childNodes.length;)this.node.appendChild(n.childNodes[0]);return this}},d.Handler=function(t,e,n,s,i,r,o){this.handler=t,this.ns=e,this.name=n,this.type=s,this.id=i,this.options=o||{matchBareFromJid:!1,ignoreNamespaceFragment:!1},this.options.matchBare&&(d.warn('The "matchBare" option is deprecated, use "matchBareFromJid" instead.'),this.options.matchBareFromJid=this.options.matchBare,delete this.options.matchBare),this.options.matchBareFromJid?this.from=r?d.getBareJidFromJid(r):null:this.from=r,this.user=!0},d.Handler.prototype={getNamespace:function(t){var e=t.getAttribute("xmlns");return e&&this.options.ignoreNamespaceFragment&&(e=e.split("#")[0]),e},namespaceMatch:function(t){var e=!1;if(!this.ns)return!0;var n=this;return d.forEachChild(t,null,function(t){n.getNamespace(t)===n.ns&&(e=!0)}),e=e||this.getNamespace(t)===this.ns},isMatch:function(t){var e=t.getAttribute("from");this.options.matchBareFromJid&&(e=d.getBareJidFromJid(e));var n=t.getAttribute("type");return!(!this.namespaceMatch(t)||this.name&&!d.isTagEqual(t,this.name)||this.type&&(Array.isArray(this.type)?-1===this.type.indexOf(n):n!==this.type)||this.id&&t.getAttribute("id")!==this.id||this.from&&e!==this.from)},run:function(t){var e=null;try{e=this.handler(t)}catch(t){throw d._handleError(t),t}return e},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}},d.TimedHandler=function(t,e){this.period=t,this.handler=e,this.lastCalled=(new Date).getTime(),this.user=!0},d.TimedHandler.prototype={run:function(){return this.lastCalled=(new Date).getTime(),this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}},d.Connection=function(t,e){this.service=t,this.options=e||{};var n=this.options.protocol||"";for(var s in 0===t.indexOf("ws:")||0===t.indexOf("wss:")||0===n.indexOf("ws")?this._proto=new d.Websocket(this):this._proto=new d.Bosh(this),this.jid="",this.domain=null,this.features=null,this._sasl_data={},this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.protocolErrorHandlers={HTTP:{},websocket:{}},this._idleTimeout=null,this._disconnectTimeout=null,this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.do_authentication=!0,this.paused=!1,this.restored=!1,this._data=[],this._uniqueId=0,this._sasl_success_handler=null,this._sasl_failure_handler=null,this._sasl_challenge_handler=null,this.maxRetries=5,this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100),y.addCookies(this.options.cookies),this.registerSASLMechanisms(this.options.mechanisms),d._connectionPlugins)if(d._connectionPlugins.hasOwnProperty(s)){function i(){}var r=d._connectionPlugins[s];i.prototype=r,this[s]=new i,this[s].init(this)}},d.Connection.prototype={reset:function(){this._proto._reset(),this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.restored=!1,this._data=[],this._requests=[],this._uniqueId=0},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(t){var e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)});return"string"==typeof t||"number"==typeof t?e+":"+t:e+""},addProtocolErrorHandler:function(t,e,n){this.protocolErrorHandlers[t][e]=n},connect:function(t,e,n,s,i,r,o){this.jid=t,this.authzid=d.getBareJidFromJid(this.jid),this.authcid=o||d.getNodeFromJid(this.jid),this.pass=e,this.servtype="xmpp",this.connect_callback=n,this.disconnecting=!1,this.connected=!1,this.authenticated=!1,this.restored=!1,this.domain=d.getDomainFromJid(this.jid),this._changeConnectStatus(d.Status.CONNECTING,null),this._proto._connect(s,i,r)},attach:function(t,e,n,s,i,r,o){if(!(this._proto instanceof d.Bosh))throw{name:"StropheSessionError",message:'The "attach" method can only be used with a BOSH connection.'};this._proto._attach(t,e,n,s,i,r,o)},restore:function(t,e,n,s,i){if(!this._sessionCachingSupported())throw{name:"StropheSessionError",message:'The "restore" method can only be used with a BOSH connection.'};this._proto._restore(t,e,n,s,i)},_sessionCachingSupported:function(){if(this._proto instanceof d.Bosh){if(!JSON)return!1;try{sessionStorage.setItem("_strophe_","_strophe_"),sessionStorage.removeItem("_strophe_")}catch(t){return!1}return!0}return!1},xmlInput:function(t){},xmlOutput:function(t){},rawInput:function(t){},rawOutput:function(t){},nextValidRid:function(t){},send:function(t){if(null!==t){if("function"==typeof t.sort)for(var e=0;e<t.length;e++)this._queueData(t[e]);else"function"==typeof t.tree?this._queueData(t.tree()):this._queueData(t);this._proto._send()}},flush:function(){clearTimeout(this._idleTimeout),this._onIdle()},sendPresence:function(t,e,n,s){var i=null,r=this;"function"==typeof t.tree&&(t=t.tree());var o=t.getAttribute("id");if(o||(o=this.getUniqueId("sendPresence"),t.setAttribute("id",o)),"function"==typeof e||"function"==typeof n){var a=this.addHandler(function(t){i&&r.deleteTimedHandler(i),"error"===t.getAttribute("type")?n&&n(t):e&&e(t)},null,"presence",null,o);s&&(i=this.addTimedHandler(s,function(){return r.deleteHandler(a),n&&n(null),!1}))}return this.send(t),o},sendIQ:function(t,n,s,e){var i=null,r=this;"function"==typeof t.tree&&(t=t.tree());var o=t.getAttribute("id");if(o||(o=this.getUniqueId("sendIQ"),t.setAttribute("id",o)),"function"==typeof n||"function"==typeof s){var a=this.addHandler(function(t){i&&r.deleteTimedHandler(i);var e=t.getAttribute("type");if("result"===e)n&&n(t);else{if("error"!==e)throw{name:"StropheError",message:"Got bad IQ type of "+e};s&&s(t)}},null,"iq",["error","result"],o);e&&(i=this.addTimedHandler(e,function(){return r.deleteHandler(a),s&&s(null),!1}))}return this.send(t),o},_queueData:function(t){if(null===t||!t.tagName||!t.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(t)},_sendRestart:function(){this._data.push("restart"),this._proto._sendRestart(),this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100)},addTimedHandler:function(t,e){var n=new d.TimedHandler(t,e);return this.addTimeds.push(n),n},deleteTimedHandler:function(t){this.removeTimeds.push(t)},addHandler:function(t,e,n,s,i,r,o){var a=new d.Handler(t,e,n,s,i,r,o);return this.addHandlers.push(a),a},deleteHandler:function(t){this.removeHandlers.push(t);var e=this.addHandlers.indexOf(t);0<=e&&this.addHandlers.splice(e,1)},registerSASLMechanisms:function(t){this.mechanisms={},(t=t||[d.SASLAnonymous,d.SASLExternal,d.SASLMD5,d.SASLOAuthBearer,d.SASLXOAuth2,d.SASLPlain,d.SASLSHA1]).forEach(this.registerSASLMechanism.bind(this))},registerSASLMechanism:function(t){this.mechanisms[t.prototype.name]=t},disconnect:function(t){if(this._changeConnectStatus(d.Status.DISCONNECTING,t),d.info("Disconnect was called because: "+t),this.connected){var e=!1;this.disconnecting=!0,this.authenticated&&(e=n({xmlns:d.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(3e3,this._onDisconnectTimeout.bind(this)),this._proto._disconnect(e)}else d.info("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests(),this._doDisconnect()},_changeConnectStatus:function(t,e,n){for(var s in d._connectionPlugins)if(d._connectionPlugins.hasOwnProperty(s)){var i=this[s];if(i.statusChanged)try{i.statusChanged(t,e)}catch(t){d.error(s+" plugin caused an exception changing status: "+t)}}if(this.connect_callback)try{this.connect_callback(t,e,n)}catch(t){d._handleError(t),d.error("User connection callback caused an exception: "+t)}},_doDisconnect:function(t){"number"==typeof this._idleTimeout&&clearTimeout(this._idleTimeout),null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null),d.info("_doDisconnect was called"),this._proto._doDisconnect(),this.authenticated=!1,this.disconnecting=!1,this.restored=!1,this.handlers=[],this.timedHandlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this._changeConnectStatus(d.Status.DISCONNECTED,t),this.connected=!1},_dataRecv:function(t,e){d.info("_dataRecv called");var n=this._proto._reqToData(t);if(null!==n){var s,i;for(this.xmlInput!==d.Connection.prototype.xmlInput&&(n.nodeName===this._proto.strip&&n.childNodes.length?this.xmlInput(n.childNodes[0]):this.xmlInput(n)),this.rawInput!==d.Connection.prototype.rawInput&&(e?this.rawInput(e):this.rawInput(d.serialize(n)));0<this.removeHandlers.length;)i=this.removeHandlers.pop(),0<=(s=this.handlers.indexOf(i))&&this.handlers.splice(s,1);for(;0<this.addHandlers.length;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue())this._doDisconnect();else{var r,o,a=n.getAttribute("type");if(null!==a&&"terminate"===a){if(this.disconnecting)return;return r=n.getAttribute("condition"),o=n.getElementsByTagName("conflict"),null!==r?("remote-stream-error"===r&&0<o.length&&(r="conflict"),this._changeConnectStatus(d.Status.CONNFAIL,r)):this._changeConnectStatus(d.Status.CONNFAIL,d.ErrorCondition.UNKOWN_REASON),void this._doDisconnect(r)}var h=this;d.forEachChild(n,null,function(t){var e,n;for(n=h.handlers,h.handlers=[],e=0;e<n.length;e++){var s=n[e];try{!s.isMatch(t)||!h.authenticated&&s.user?h.handlers.push(s):s.run(t)&&h.handlers.push(s)}catch(t){d.warn("Removing Strophe handlers due to uncaught exception: "+t.message)}}})}}},mechanisms:{},_no_auth_received:function(t){d.error("Server did not offer a supported authentication mechanism"),this._changeConnectStatus(d.Status.CONNFAIL,d.ErrorCondition.NO_AUTH_MECH),t&&t.call(this),this._doDisconnect()},_connect_cb:function(t,e,n){var s;d.info("_connect_cb was called"),this.connected=!0;try{s=this._proto._reqToData(t)}catch(t){if("badformat"!==t)throw t;this._changeConnectStatus(d.Status.CONNFAIL,d.ErrorCondition.BAD_FORMAT),this._doDisconnect(d.ErrorCondition.BAD_FORMAT)}if(s&&(this.xmlInput!==d.Connection.prototype.xmlInput&&(s.nodeName===this._proto.strip&&s.childNodes.length?this.xmlInput(s.childNodes[0]):this.xmlInput(s)),this.rawInput!==d.Connection.prototype.rawInput&&(n?this.rawInput(n):this.rawInput(d.serialize(s))),this._proto._connect_cb(s)!==d.Status.CONNFAIL))if(s.getElementsByTagNameNS?0<s.getElementsByTagNameNS(d.NS.STREAM,"features").length:0<s.getElementsByTagName("stream:features").length||0<s.getElementsByTagName("features").length){var i,r,o=[],a=s.getElementsByTagName("mechanism");if(0<a.length)for(i=0;i<a.length;i++)r=d.getText(a[i]),this.mechanisms[r]&&o.push(this.mechanisms[r]);0!==o.length||0!==s.getElementsByTagName("auth").length?!1!==this.do_authentication&&this.authenticate(o):this._no_auth_received(e)}else this._no_auth_received(e)},sortMechanismsByPriority:function(t){var e,n,s,i;for(e=0;e<t.length-1;++e){for(n=(s=e)+1;n<t.length;++n)t[n].prototype.priority>t[s].prototype.priority&&(s=n);s!==e&&(i=t[e],t[e]=t[s],t[s]=i)}return t},_attemptSASLAuth:function(t){t=this.sortMechanismsByPriority(t||[]);var e=0,n=!1;for(e=0;e<t.length;++e)if(t[e].prototype.test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null),this._sasl_mechanism=new t[e],this._sasl_mechanism.onStart(this);var s=r("auth",{xmlns:d.NS.SASL,mechanism:this._sasl_mechanism.name});if(this._sasl_mechanism.isClientFirst){var i=this._sasl_mechanism.onChallenge(this,null);s.t(btoa(i))}this.send(s.tree()),n=!0;break}return n},_attemptLegacyAuth:function(){null===d.getNodeFromJid(this.jid)?(this._changeConnectStatus(d.Status.CONNFAIL,d.ErrorCondition.MISSING_JID_NODE),this.disconnect(d.ErrorCondition.MISSING_JID_NODE)):(this._changeConnectStatus(d.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(i({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:d.NS.AUTH}).c("username",{}).t(d.getNodeFromJid(this.jid)).tree()))},authenticate:function(t){this._attemptSASLAuth(t)||this._attemptLegacyAuth()},_sasl_challenge_cb:function(t){var e=atob(d.getText(t)),n=this._sasl_mechanism.onChallenge(this,e),s=r("response",{xmlns:d.NS.SASL});return""!==n&&s.t(btoa(n)),this.send(s.tree()),!0},_auth1_cb:function(t){var e=i({type:"set",id:"_auth_2"}).c("query",{xmlns:d.NS.AUTH}).c("username",{}).t(d.getNodeFromJid(this.jid)).up().c("password").t(this.pass);return d.getResourceFromJid(this.jid)||(this.jid=d.getBareJidFromJid(this.jid)+"/strophe"),e.up().c("resource",{}).t(d.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2"),this.send(e.tree()),!1},_sasl_success_cb:function(t){if(this._sasl_data["server-signature"]){var e,n=atob(d.getText(t)).match(/([a-z]+)=([^,]+)(,|$)/);if("v"===n[1]&&(e=n[2]),e!==this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}d.info("SASL authentication succeeded."),this._sasl_mechanism&&this._sasl_mechanism.onSuccess(),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);function s(t,e){for(;t.length;)this.deleteHandler(t.pop());return this._sasl_auth1_cb.bind(this)(e),!1}var i=[];return i.push(this._addSysHandler(function(t){s.bind(this)(i,t)}.bind(this),null,"stream:features",null,null)),i.push(this._addSysHandler(function(t){s.bind(this)(i,t)}.bind(this),d.NS.STREAM,"features",null,null)),this._sendRestart(),!1},_sasl_auth1_cb:function(t){var e,n;for(this.features=t,e=0;e<t.childNodes.length;e++)"bind"===(n=t.childNodes[e]).nodeName&&(this.do_bind=!0),"session"===n.nodeName&&(this.do_session=!0);if(!this.do_bind)return this._changeConnectStatus(d.Status.AUTHFAIL,null),!1;this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2");var s=d.getResourceFromJid(this.jid);return s?this.send(i({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:d.NS.BIND}).c("resource",{}).t(s).tree()):this.send(i({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:d.NS.BIND}).tree()),!1},_sasl_bind_cb:function(t){var e;if("error"===t.getAttribute("type"))return d.info("SASL binding failed."),0<t.getElementsByTagName("conflict").length&&(e=d.ErrorCondition.CONFLICT),this._changeConnectStatus(d.Status.AUTHFAIL,e,t),!1;var n,s=t.getElementsByTagName("bind");if(!(0<s.length))return d.info("SASL binding failed."),this._changeConnectStatus(d.Status.AUTHFAIL,null,t),!1;0<(n=s[0].getElementsByTagName("jid")).length&&(this.jid=d.getText(n[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(i({type:"set",id:"_session_auth_2"}).c("session",{xmlns:d.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(d.Status.CONNECTED,null)))},_sasl_session_cb:function(t){if("result"===t.getAttribute("type"))this.authenticated=!0,this._changeConnectStatus(d.Status.CONNECTED,null);else if("error"===t.getAttribute("type"))return d.info("Session creation failed."),this._changeConnectStatus(d.Status.AUTHFAIL,null,t),!1;return!1},_sasl_failure_cb:function(t){return this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_mechanism&&this._sasl_mechanism.onFailure(),this._changeConnectStatus(d.Status.AUTHFAIL,null,t),!1},_auth2_cb:function(t){return"result"===t.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(d.Status.CONNECTED,null)):"error"===t.getAttribute("type")&&(this._changeConnectStatus(d.Status.AUTHFAIL,null,t),this.disconnect("authentication failed")),!1},_addSysTimedHandler:function(t,e){var n=new d.TimedHandler(t,e);return n.user=!1,this.addTimeds.push(n),n},_addSysHandler:function(t,e,n,s,i){var r=new d.Handler(t,e,n,s,i);return r.user=!1,this.addHandlers.push(r),r},_onDisconnectTimeout:function(){return d.info("_onDisconnectTimeout was called"),this._changeConnectStatus(d.Status.CONNTIMEOUT,null),this._proto._onDisconnectTimeout(),this._doDisconnect(),!1},_onIdle:function(){for(var t,e,n;0<this.addTimeds.length;)this.timedHandlers.push(this.addTimeds.pop());for(;0<this.removeTimeds.length;)e=this.removeTimeds.pop(),0<=(t=this.timedHandlers.indexOf(e))&&this.timedHandlers.splice(t,1);var s=(new Date).getTime();for(n=[],t=0;t<this.timedHandlers.length;t++)e=this.timedHandlers[t],!this.authenticated&&e.user||(e.lastCalled+e.period-s<=0?e.run()&&n.push(e):n.push(e));this.timedHandlers=n,clearTimeout(this._idleTimeout),this._proto._onIdle(),this.connected&&(this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100))}},d.SASLMechanism=function(t,e,n){this.name=t,this.isClientFirst=e,this.priority=n},d.SASLMechanism.prototype={test:function(t){return!0},onStart:function(t){this._connection=t},onChallenge:function(t,e){throw new Error("You should implement challenge handling!")},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}},d.SASLAnonymous=function(){},d.SASLAnonymous.prototype=new d.SASLMechanism("ANONYMOUS",!1,20),d.SASLAnonymous.prototype.test=function(t){return null===t.authcid},d.SASLPlain=function(){},d.SASLPlain.prototype=new d.SASLMechanism("PLAIN",!0,50),d.SASLPlain.prototype.test=function(t){return null!==t.authcid},d.SASLPlain.prototype.onChallenge=function(t){var e=t.authzid;return e+="\0",e+=t.authcid,e+="\0",e+=t.pass,y.utf16to8(e)},d.SASLSHA1=function(){},d.SASLSHA1.prototype=new d.SASLMechanism("SCRAM-SHA-1",!0,70),d.SASLSHA1.prototype.test=function(t){return null!==t.authcid},d.SASLSHA1.prototype.onChallenge=function(t,e,n){var s=n||_.hexdigest(1234567890*Math.random()),i="n="+y.utf16to8(t.authcid);return i+=",r=",i+=s,t._sasl_data.cnonce=s,i="n,,"+(t._sasl_data["client-first-message-bare"]=i),this.onChallenge=function(t,e){for(var n,s,i,r,o,a,h,c,u,l,d,p,_="c=biws,",f=t._sasl_data["client-first-message-bare"]+","+e+",",m=t._sasl_data.cnonce,g=/([a-z]+)=([^,]+)(,|$)/;e.match(g);){var S=e.match(g);switch(e=e.replace(S[0],""),S[1]){case"r":n=S[2];break;case"s":s=S[2];break;case"i":i=S[2]}}if(n.substr(0,m.length)!==m)return t._sasl_data={},t._sasl_failure_cb();for(f+=_+="r="+n,s=atob(s),s+="\0\0\0",u=y.utf16to8(t.pass),r=a=b.core_hmac_sha1(u,s),h=1;h<i;h++){for(o=b.core_hmac_sha1(u,b.binb2str(a)),c=0;c<5;c++)r[c]^=o[c];a=o}for(r=b.binb2str(r),l=b.core_hmac_sha1(r,"Client Key"),d=b.str_hmac_sha1(r,"Server Key"),p=b.core_hmac_sha1(b.str_sha1(b.binb2str(l)),f),t._sasl_data["server-signature"]=b.b64_hmac_sha1(d,f),c=0;c<5;c++)l[c]^=p[c];return _+=",p="+btoa(b.binb2str(l))}.bind(this),i},d.SASLMD5=function(){},d.SASLMD5.prototype=new d.SASLMechanism("DIGEST-MD5",!1,60),d.SASLMD5.prototype.test=function(t){return null!==t.authcid},d.SASLMD5.prototype._quote=function(t){return'"'+t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},d.SASLMD5.prototype.onChallenge=function(t,e,n){for(var s,i=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,r=n||_.hexdigest(""+1234567890*Math.random()),o="",a=null,h="";e.match(i);)switch(s=e.match(i),e=e.replace(s[0],""),s[2]=s[2].replace(/^"(.+)"$/,"$1"),s[1]){case"realm":o=s[2];break;case"nonce":h=s[2];break;case"qop":s[2];break;case"host":a=s[2]}var c=t.servtype+"/"+t.domain;null!==a&&(c=c+"/"+a);var u=y.utf16to8(t.authcid+":"+o+":"+this._connection.pass),l=_.hash(u)+":"+h+":"+r,d="AUTHENTICATE:"+c,p="";return p+="charset=utf-8,",p+="username="+this._quote(y.utf16to8(t.authcid))+",",p+="realm="+this._quote(o)+",",p+="nonce="+this._quote(h)+",",p+="nc=00000001,",p+="cnonce="+this._quote(r)+",",p+="digest-uri="+this._quote(c)+",",p+="response="+_.hexdigest(_.hexdigest(l)+":"+h+":00000001:"+r+":auth:"+_.hexdigest(d))+",",p+="qop=auth",this.onChallenge=function(){return""},p},d.SASLOAuthBearer=function(){},d.SASLOAuthBearer.prototype=new d.SASLMechanism("OAUTHBEARER",!0,40),d.SASLOAuthBearer.prototype.test=function(t){return null!==t.pass},d.SASLOAuthBearer.prototype.onChallenge=function(t){var e="n,";return null!==t.authcid&&(e=e+"a="+t.authzid),e+=",",e+="",e+="auth=Bearer ",e+=t.pass,e+="",e+="",y.utf16to8(e)},d.SASLExternal=function(){},d.SASLExternal.prototype=new d.SASLMechanism("EXTERNAL",!0,10),d.SASLExternal.prototype.onChallenge=function(t){return t.authcid===t.authzid?"":t.authzid},d.SASLXOAuth2=function(){},d.SASLXOAuth2.prototype=new d.SASLMechanism("X-OAUTH2",!0,30),d.SASLXOAuth2.prototype.test=function(t){return null!==t.pass},d.SASLXOAuth2.prototype.onChallenge=function(t){var e="\0";return null!==t.authcid&&(e+=t.authzid),e+="\0",e+=t.pass,y.utf16to8(e)},{Strophe:d,$build:r,$iq:i,$msg:function(t){return new d.Builder("message",t)},$pres:n,SHA1:b,MD5:_,b64_hmac_sha1:b.b64_hmac_sha1,b64_sha1:b.b64_sha1,str_hmac_sha1:b.str_hmac_sha1,str_sha1:b.str_sha1}}),function(t,e){if("function"==typeof i&&i.amd)i("strophe-bosh",["strophe-core"],function(t){return e(t.Strophe,t.$build)});else{if("object"!=typeof exports)return e(Strophe,$build);var n=s("./core");module.exports=e(n.Strophe,n.$build)}}(0,function(l,e){return l.Request=function(t,e,n,s){this.id=++l._requestId,this.xmlData=t,this.data=l.serialize(t),this.origFunc=e,this.func=e,this.rid=n,this.date=NaN,this.sends=s||0,this.abort=!1,this.dead=null,this.age=function(){return this.date?(new Date-this.date)/1e3:0},this.timeDead=function(){return this.dead?(new Date-this.dead)/1e3:0},this.xhr=this._newXHR()},l.Request.prototype={getResponse:function(){var t=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if("parsererror"===(t=this.xhr.responseXML.documentElement).tagName)throw l.error("invalid response received"),l.error("responseText: "+this.xhr.responseText),l.error("responseXML: "+l.serialize(this.xhr.responseXML)),"parsererror"}else if(this.xhr.responseText){if(l.debug("Got responseText but no responseXML; attempting to parse it with DOMParser..."),!(t=(new DOMParser).parseFromString(this.xhr.responseText,"application/xml").documentElement))throw new Error("Parsing produced null node");if(t.querySelector("parsererror"))throw l.error("invalid response received: "+t.querySelector("parsererror").textContent),l.error("responseText: "+this.xhr.responseText),"badformat"}return t},_newXHR:function(){var t=null;return window.XMLHttpRequest?(t=new XMLHttpRequest).overrideMimeType&&t.overrideMimeType("text/xml; charset=utf-8"):window.ActiveXObject&&(t=new ActiveXObject("Microsoft.XMLHTTP")),t.onreadystatechange=this.func.bind(null,this),t}},l.Bosh=function(t){this._conn=t,this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.hold=1,this.wait=60,this.window=5,this.errors=0,this.inactivity=null,this.lastResponseHeaders=null,this._requests=[]},l.Bosh.prototype={strip:null,_buildBody:function(){var t=e("body",{rid:this.rid++,xmlns:l.NS.HTTPBIND});return null!==this.sid&&t.attrs({sid:this.sid}),this._conn.options.keepalive&&this._conn._sessionCachingSupported()&&this._cacheSession(),t},_reset:function(){this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.errors=0,this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session"),this._conn.nextValidRid(this.rid)},_connect:function(t,e,n){this.wait=t||this.wait,this.hold=e||this.hold,this.errors=0;var s=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":l.NS.BOSH});n&&s.attrs({route:n});var i=this._conn._connect_cb;this._requests.push(new l.Request(s.tree(),this._onRequestStateChange.bind(this,i.bind(this._conn)),s.tree().getAttribute("rid"))),this._throttledRequestHandler()},_attach:function(t,e,n,s,i,r,o){this._conn.jid=t,this.sid=e,this.rid=n,this._conn.connect_callback=s,this._conn.domain=l.getDomainFromJid(this._conn.jid),this._conn.authenticated=!0,this._conn.connected=!0,this.wait=i||this.wait,this.hold=r||this.hold,this.window=o||this.window,this._conn._changeConnectStatus(l.Status.ATTACHED,null)},_restore:function(t,e,n,s,i){var r=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(!(null!=r&&r.rid&&r.sid&&r.jid&&(null==t||l.getBareJidFromJid(r.jid)===l.getBareJidFromJid(t)||null===l.getNodeFromJid(t)&&l.getDomainFromJid(r.jid)===t)))throw{name:"StropheSessionError",message:"_restore: no restoreable session."};this._conn.restored=!0,this._attach(r.jid,r.sid,r.rid,e,n,s,i)},_cacheSession:function(){this._conn.authenticated?this._conn.jid&&this.rid&&this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid})):window.sessionStorage.removeItem("strophe-bosh-session")},_connect_cb:function(t){var e,n,s=t.getAttribute("type");if(null!==s&&"terminate"===s)return e=t.getAttribute("condition"),l.error("BOSH-Connection failed: "+e),n=t.getElementsByTagName("conflict"),null!==e?("remote-stream-error"===e&&0<n.length&&(e="conflict"),this._conn._changeConnectStatus(l.Status.CONNFAIL,e)):this._conn._changeConnectStatus(l.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(e),l.Status.CONNFAIL;this.sid||(this.sid=t.getAttribute("sid"));var i=t.getAttribute("requests");i&&(this.window=parseInt(i,10));var r=t.getAttribute("hold");r&&(this.hold=parseInt(r,10));var o=t.getAttribute("wait");o&&(this.wait=parseInt(o,10));var a=t.getAttribute("inactivity");a&&(this.inactivity=parseInt(a,10))},_disconnect:function(t){this._sendTerminate(t)},_doDisconnect:function(){this.sid=null,this.rid=Math.floor(4294967295*Math.random()),this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session"),this._conn.nextValidRid(this.rid)},_emptyQueue:function(){return 0===this._requests.length},_callProtocolErrorHandlers:function(t){var e,n=this._getRequestStatus(t);(e=this._conn.protocolErrorHandlers.HTTP[n])&&e.call(this,n)},_hitError:function(t){this.errors++,l.warn("request errored, status: "+t+", number of errors: "+this.errors),4<this.errors&&this._conn._onDisconnectTimeout()},_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function(){for(var t;0<this._requests.length;)(t=this._requests.pop()).abort=!0,t.xhr.abort(),t.xhr.onreadystatechange=function(){}},_onIdle:function(){var t=this._conn._data;if(this._conn.authenticated&&0===this._requests.length&&0===t.length&&!this._conn.disconnecting&&(l.info("no requests during idle cycle, sending blank request"),t.push(null)),!this._conn.paused){if(this._requests.length<2&&0<t.length){for(var e=this._buildBody(),n=0;n<t.length;n++)null!==t[n]&&("restart"===t[n]?e.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":l.NS.BOSH}):e.cnode(t[n]).up());delete this._conn._data,this._conn._data=[],this._requests.push(new l.Request(e.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),e.tree().getAttribute("rid"))),this._throttledRequestHandler()}if(0<this._requests.length){var s=this._requests[0].age();null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(l.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),s>Math.floor(l.TIMEOUT*this.wait)&&(l.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(l.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler())}}},_getRequestStatus:function(t,e){var n;if(4===t.xhr.readyState)try{n=t.xhr.status}catch(t){l.error("Caught an error while retrieving a request's status, reqStatus: "+n)}return void 0===n&&(n="number"==typeof e?e:0),n},_onRequestStateChange:function(t,e){if(l.debug("request id "+e.id+"."+e.sends+" state changed to "+e.xhr.readyState),e.abort)e.abort=!1;else if(4===e.xhr.readyState){var n=this._getRequestStatus(e);if(this.lastResponseHeaders=e.xhr.getAllResponseHeaders(),this.disconnecting&&400<=n)return this._hitError(n),void this._callProtocolErrorHandlers(e);var s=0<n&&n<500,i=e.sends>this._conn.maxRetries;if((s||i)&&(this._removeRequest(e),l.debug("request id "+e.id+" should now be removed")),200===n){var r=this._requests[0]===e;(this._requests[1]===e||r&&0<this._requests.length&&this._requests[0].age()>Math.floor(l.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),this._conn.nextValidRid(Number(e.rid)+1),l.debug("request id "+e.id+"."+e.sends+" got 200"),t(e),this.errors=0}else 0===n||400<=n&&n<600||12e3<=n?(l.error("request id "+e.id+"."+e.sends+" error "+n+" happened"),this._hitError(n),this._callProtocolErrorHandlers(e),400<=n&&n<500&&(this._conn._changeConnectStatus(l.Status.DISCONNECTING,null),this._conn._doDisconnect())):l.error("request id "+e.id+"."+e.sends+" error "+n+" happened");s||i?i&&!this._conn.connected&&this._conn._changeConnectStatus(l.Status.CONNFAIL,"giving-up"):this._throttledRequestHandler()}},_processRequest:function(t){var n=this,s=this._requests[t],e=this._getRequestStatus(s,-1);if(s.sends>this._conn.maxRetries)this._conn._onDisconnectTimeout();else{var i=s.age(),r=!isNaN(i)&&i>Math.floor(l.TIMEOUT*this.wait),o=null!==s.dead&&s.timeDead()>Math.floor(l.SECONDARY_TIMEOUT*this.wait),a=4===s.xhr.readyState&&(e<1||500<=e);if((r||o||a)&&(o&&l.error("Request "+this._requests[t].id+" timed out (secondary), restarting"),s.abort=!0,s.xhr.abort(),s.xhr.onreadystatechange=function(){},this._requests[t]=new l.Request(s.xmlData,s.origFunc,s.rid,s.sends),s=this._requests[t]),0===s.xhr.readyState){l.debug("request id "+s.id+"."+s.sends+" posting");try{var h=this._conn.options.contentType||"text/xml; charset=utf-8";s.xhr.open("POST",this._conn.service,!this._conn.options.sync),void 0!==s.xhr.setRequestHeader&&s.xhr.setRequestHeader("Content-Type",h),this._conn.options.withCredentials&&(s.xhr.withCredentials=!0)}catch(t){return l.error("XHR open failed: "+t.toString()),this._conn.connected||this._conn._changeConnectStatus(l.Status.CONNFAIL,"bad-service"),void this._conn.disconnect()}function c(){if(s.date=new Date,n._conn.options.customHeaders){var t=n._conn.options.customHeaders;for(var e in t)t.hasOwnProperty(e)&&s.xhr.setRequestHeader(e,t[e])}s.xhr.send(s.data)}if(1<s.sends){var u=1e3*Math.min(Math.floor(l.TIMEOUT*this.wait),Math.pow(s.sends,3));setTimeout(function(){c()},u)}else c();s.sends++,this._conn.xmlOutput!==l.Connection.prototype.xmlOutput&&(s.xmlData.nodeName===this.strip&&s.xmlData.childNodes.length?this._conn.xmlOutput(s.xmlData.childNodes[0]):this._conn.xmlOutput(s.xmlData)),this._conn.rawOutput!==l.Connection.prototype.rawOutput&&this._conn.rawOutput(s.data)}else l.debug("_processRequest: "+(0===t?"first":"second")+" request has readyState of "+s.xhr.readyState)}},_removeRequest:function(t){var e;for(l.debug("removing request"),e=this._requests.length-1;0<=e;e--)t===this._requests[e]&&this._requests.splice(e,1);t.xhr.onreadystatechange=function(){},this._throttledRequestHandler()},_restartRequest:function(t){var e=this._requests[t];null===e.dead&&(e.dead=new Date),this._processRequest(t)},_reqToData:function(t){try{return t.getResponse()}catch(t){if("parsererror"!==t)throw t;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(t){l.info("_sendTerminate was called");var e=this._buildBody().attrs({type:"terminate"});t&&e.cnode(t.tree());var n=new l.Request(e.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),e.tree().getAttribute("rid"));this._requests.push(n),this._throttledRequestHandler()},_send:function(){clearTimeout(this._conn._idleTimeout),this._throttledRequestHandler(),this._conn._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler(),clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){this._requests?l.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):l.debug("_throttledRequestHandler called with undefined requests"),this._requests&&0!==this._requests.length&&(0<this._requests.length&&this._processRequest(0),1<this._requests.length&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}},l}),function(t,e){if("function"==typeof i&&i.amd)i("strophe-websocket",["strophe-core"],function(t){return e(t.Strophe,t.$build)});else{if("object"!=typeof exports)return e(Strophe,$build);var n=s("./core");module.exports=e(n.Strophe,n.$build)}}(0,function(c,s){return c.Websocket=function(t){this._conn=t,this.strip="wrapper";var e=t.service;if(0!==e.indexOf("ws:")&&0!==e.indexOf("wss:")){var n="";"ws"===t.options.protocol&&"https:"!==window.location.protocol?n+="ws":n+="wss",n+="://"+window.location.host,0!==e.indexOf("/")?n+=window.location.pathname+e:n+=e,t.service=n}},c.Websocket.prototype={_buildStream:function(){return s("open",{xmlns:c.NS.FRAMING,to:this._conn.domain,version:"1.0"})},_check_streamerror:function(t,e){var n;if(0===(n=t.getElementsByTagNameNS?t.getElementsByTagNameNS(c.NS.STREAM,"error"):t.getElementsByTagName("stream:error")).length)return!1;for(var s=n[0],i="",r="",o=0;o<s.childNodes.length;o++){var a=s.childNodes[o];if("urn:ietf:params:xml:ns:xmpp-streams"!==a.getAttribute("xmlns"))break;"text"===a.nodeName?r=a.textContent:i=a.nodeName}var h="WebSocket stream error: ";return h+=i||"unknown",r&&(h+=" - "+r),c.error(h),this._conn._changeConnectStatus(e,i),this._conn._doDisconnect(),!0},_reset:function(){},_connect:function(){this._closeSocket(),this.socket=new WebSocket(this._conn.service,"xmpp"),this.socket.onopen=this._onOpen.bind(this),this.socket.onerror=this._onError.bind(this),this.socket.onclose=this._onClose.bind(this),this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(t){if(this._check_streamerror(t,c.Status.CONNFAIL))return c.Status.CONNFAIL},_handleStreamStart:function(t){var e=!1,n=t.getAttribute("xmlns");"string"!=typeof n?e="Missing xmlns in <open />":n!==c.NS.FRAMING&&(e="Wrong xmlns in <open />: "+n);var s=t.getAttribute("version");return"string"!=typeof s?e="Missing version in <open />":"1.0"!==s&&(e="Wrong version in <open />: "+s),!e||(this._conn._changeConnectStatus(c.Status.CONNFAIL,e),this._conn._doDisconnect(),!1)},_connect_cb_wrapper:function(t){if(0===t.data.indexOf("<open ")||0===t.data.indexOf("<?xml")){var e=t.data.replace(/^(<\?.*?\?>\s*)*/,"");if(""===e)return;var n=(new DOMParser).parseFromString(e,"text/xml").documentElement;this._conn.xmlInput(n),this._conn.rawInput(t.data),this._handleStreamStart(n)&&this._connect_cb(n)}else if(0===t.data.indexOf("<close ")){this._conn.rawInput(t.data),this._conn.xmlInput(t);var s=t.getAttribute("see-other-uri");s?(this._conn._changeConnectStatus(c.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=s,this._connect()):(this._conn._changeConnectStatus(c.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect())}else{var i=this._streamWrap(t.data),r=(new DOMParser).parseFromString(i,"text/xml").documentElement;this.socket.onmessage=this._onMessage.bind(this),this._conn._connect_cb(r,null,t.data)}},_disconnect:function(t){if(this.socket&&this.socket.readyState!==WebSocket.CLOSED){t&&this._conn.send(t);var e=s("close",{xmlns:c.NS.FRAMING});this._conn.xmlOutput(e.tree());var n=c.serialize(e);this._conn.rawOutput(n);try{this.socket.send(n)}catch(t){c.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){c.info("WebSockets _doDisconnect was called"),this._closeSocket()},_streamWrap:function(t){return"<wrapper>"+t+"</wrapper>"},_closeSocket:function(){if(this.socket)try{this.socket.onerror=null,this.socket.close()}catch(t){}this.socket=null},_emptyQueue:function(){return!0},_onClose:function(t){this._conn.connected&&!this._conn.disconnecting?(c.error("Websocket closed unexpectedly"),this._conn._doDisconnect()):t&&1006===t.code&&!this._conn.connected&&this.socket?(c.error("Websocket closed unexcectedly"),this._conn._changeConnectStatus(c.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),this._conn._doDisconnect()):c.info("Websocket closed")},_onDisconnectTimeout:function(){},_abortAllRequests:function(){},_onError:function(t){c.error("Websocket error "+t),this._conn._changeConnectStatus(c.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),this._disconnect()},_onIdle:function(){var t=this._conn._data;if(0<t.length&&!this._conn.paused){for(var e=0;e<t.length;e++){var n,s;if(null!==t[e])n="restart"===t[e]?this._buildStream().tree():t[e],s=c.serialize(n),this._conn.xmlOutput(n),this._conn.rawOutput(s),this.socket.send(s)}this._conn._data=[]}},_onMessage:function(t){var e,n,s='<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />';if(t.data===s)return this._conn.rawInput(s),this._conn.xmlInput(t),void(this._conn.disconnecting||this._conn._doDisconnect());if(0===t.data.search("<open ")){if(e=(new DOMParser).parseFromString(t.data,"text/xml").documentElement,!this._handleStreamStart(e))return}else n=this._streamWrap(t.data),e=(new DOMParser).parseFromString(n,"text/xml").documentElement;return this._check_streamerror(e,c.Status.ERROR)?void 0:this._conn.disconnecting&&"presence"===e.firstChild.nodeName&&"unavailable"===e.firstChild.getAttribute("type")?(this._conn.xmlInput(e),void this._conn.rawInput(c.serialize(e))):void this._conn._dataRecv(e,t.data)},_onOpen:function(){c.info("Websocket open");var t=this._buildStream();this._conn.xmlOutput(t.tree());var e=c.serialize(t);this._conn.rawOutput(e),this.socket.send(e)},_reqToData:function(t){return t},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout),this._conn._onIdle.bind(this._conn)()}},c}),function(){if("function"==typeof i&&i.amd)i("strophe",["strophe-core","strophe-bosh","strophe-websocket"],function(t){return t});else if("object"==typeof exports){var t=s("./core");s("./bosh"),s("./websocket"),module.exports=t}}(),s(["strophe-polyfill"]),s("strophe")});